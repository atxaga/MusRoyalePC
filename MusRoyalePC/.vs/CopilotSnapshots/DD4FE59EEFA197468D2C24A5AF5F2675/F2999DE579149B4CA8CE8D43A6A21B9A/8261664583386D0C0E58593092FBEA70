using MusRoyalePC.Models;
using System;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows;

namespace MusRoyalePC.Services;

/// <summary>
/// Coordinador global para escuchar invitaciones de dúos y mostrarlas desde cualquier vista.
/// </summary>
public sealed class DuoInviteCoordinator
{
    private static DuoInviteCoordinator? _instance;
    public static DuoInviteCoordinator Instance => _instance ??= new DuoInviteCoordinator();

    private readonly DuoMatchmakingService _service = new();
    private bool _started;

    public void Start()
    {
        string myId = FirestoreService.Instance.CurrentUserId;
        if (string.IsNullOrWhiteSpace(myId))
            myId = UserSession.Instance.DocumentId;

        Debug.WriteLine($"[DuoInviteCoordinator] Start() myId='{myId}', CurrentUserId='{FirestoreService.Instance.CurrentUserId}', SessionId='{UserSession.Instance.DocumentId}'");

        if (string.IsNullOrWhiteSpace(myId))
        {
            Debug.WriteLine("[DuoInviteCoordinator] No hay myId, no se inicia listener (se podrá reintentar). ");
            _started = false;
            return;
        }

        if (_started)
        {
            Debug.WriteLine("[DuoInviteCoordinator] Ya iniciado, ignorando.");
            return;
        }

        _started = true;

        _service.OnInviteReceived -= OnInviteReceived;
        _service.OnInviteReceived += OnInviteReceived;

        Debug.WriteLine("[DuoInviteCoordinator] ListenInvitesForUser...");
        _service.ListenInvitesForUser(myId);
    }

    public void Stop()
    {
        Debug.WriteLine("[DuoInviteCoordinator] Stop()");
        _service.OnInviteReceived -= OnInviteReceived;
        _service.StopInviteListening();
        _started = false;
    }

    private void OnInviteReceived(DuoInvite invite)
    {
        Debug.WriteLine($"[DuoInviteCoordinator] Invite received partidaId='{invite.PartidaId}', emisor='{invite.EmisorId}', receptor='{invite.ReceptorId}', apuesta={invite.Apuesta}");

        Application.Current.Dispatcher.Invoke(async () =>
        {
            // Mostrar confirmación simple global
            var result = MessageBox.Show(
                $"Duo gonbidapena jaso duzu!\nEmisor: {invite.EmisorId}\nApuesta: {invite.Apuesta}\n\nOnartu?",
                "Duo Invite",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                try
                {
                    await _service.AcceptAsync(invite.PartidaId);

                    // Mantener listener de ese doc para detectar jokatu.
                    _service.OnStateChanged += async state =>
                    {
                        if (state.PartidaId != invite.PartidaId) return;

                        if (state.Onartua && state.Jokatu)
                        {
                            await StartDuoMatchAsync(state.PartidaId, state.Apuesta);
                        }
                    };

                    _service.Listen(invite.PartidaId);
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"[DuoInviteCoordinator] Error accept/listen: {ex}");
                    MessageBox.Show(ex.Message);
                }
            }
            else
            {
                try { await _service.DeleteAsync(invite.PartidaId); } catch { }
            }
        });
    }

    private static async Task StartDuoMatchAsync(string partidaId, int apuesta)
    {
        try
        {
            if (Application.Current.MainWindow is not MainWindow mw)
                return;

            if (mw.DataContext is not MainViewModel vm)
                return;

            // Conectar al servidor con el modo ID_ESKATU (como Android)
            string ipServer = "52.72.136.36";
            int puerto = 13000;

            vm.NetService.MiIdFirestore = UserSession.Instance.DocumentId;

            string res = await vm.NetService.ConectarYUnirse(ipServer, puerto, "ID_ESKATU");
            if (res == "OK")
            {
                vm.Navegar("Partida");

                // Borrar el documento como Android (best effort)
                try
                {
                    await FirestoreService.Instance.Db.Collection("PartidaDuo").Document(partidaId).DeleteAsync();
                }
                catch { }
            }
            else
            {
                MessageBox.Show("Ezin izan da ID_ESKATU partidan sartu.");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show(ex.Message);
        }
    }
}
